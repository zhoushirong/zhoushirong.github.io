---
title: redis入门
date: 2018/11/01
tag: [redis, sentinel]
---

Redis是一个内存高速缓存数据库，redis全称 Remote Dictionary Server（远程数据服务）
Redis是一个key-value存储系统，它支持很多数据类型：string、list、set、zset、hash
Redis以内存作为存储介质，读写数据效率高，远超过数据库。
Redis也支持持久化存储，即将数据定时存储备份到硬盘，当遭遇停电或者宕机的情况下数据不至于丢失。

### ubuntu安装redis
```shell
sudo apt-get install redis-server
```

### 关闭、启动、重启 redis-server
```shell
# ubuntu 这里有点问题，通过杀进程的方式关闭不了redis，得用下面的这种方式
/etc/init.d/redis-server stop
/etc/init.d/redis-server start
/etc/init.d/redis-server restart
```

### 查看redis进程
```shell
ps -ef|grep redis
```

### 进入redis-cli
```shell
redis-cli # 本地连接
redis-cli -h REDIS_HOST_IP_ADDR -p 6379 # 通过IP地址 
```


### redis常用命令

```shell
set age 25 # 设置一个 redis 数据 age
keys * # 查看 redis 数据
get age # 查看 redis 数据 age
```

### 如果设置了密码
如果设置了密码可能回报错
```shell
(error) NOAUTH Authentication required.
```
解决办法：
```shell
redis-cli
auth 'yourpassword'
keys *
# is ok, will show all keys!
```


### redis-cluster
Redis支持集群模式，能够更稳定的存储数据


### redis-sentinel
Redis 的 Sentinel 系统用于管理多个 Redis 服务器
sentinel配置实践如下，包括两个配置文件，一个是redis服务配置，另一个是sentinel配置

#### redis配置文件
```shell
port 6379
daemonize yes
#logfile "log/6379.log"
slave-read-only no
requirepass "123456"
dbfilename "dump-6379.rdb"
# dir "/Users/zsr/learn/redis/data/"
```

#### sentinel配置文件
```shell
port 26379
# dir "/Users/zsr/learn/redis/data"
# logfile "26379.log"
sentinel myid c83c4d372c28916980ac2eca754b13cc794359fd
sentinel monitor mymaster 10.242.22.138 6379 2
#sentinel auth-pass mymaster 123456a
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
# Generated by CONFIG REWRITE
sentinel known-slave mymaster 10.242.22.138 6380
sentinel known-slave mymaster 10.242.22.138 6381
sentinel current-epoch 0
protected-mode no
```

配置完毕之后，直接运用redis-server启动sentinel服务：
```shell
redis-server sentinel-26379.conf --sentinel &;
```

配置完毕之后，直接运用redis-server启动redis服务：
```shell
redis-server redis-6379.conf
```

### 利用ioredis nodejs连接sentinel方式

```javascript
const Redis = require('ioredis')
let redisConfig = {
  sentinels: [{
    host: '10.242.22.138',
    port: 26379
  }],
  password: '123456',
  name: 'mymaster'
}
const client = new Redis(redisConfig)
let redisIsOk = false
client.on('ready', () => {
  redisIsOk = true
  global.logger.server('redis is ready!')
})
client.on('error', (err) => {
  redisIsOk = false
  global.logger.server('redis is on error! errmsg:' + err.toString(), 'ERROR')
})

module.exports = {
  /**
   * 存入redis
   * expire (单位：s)
   */
  set: (key, value, expire) => {
    return new Promise((resolve, reject) => {
      if (!redisIsOk) {
        reject(false)
      }
      client.set(key, value).then((res) => {
        resolve(true)
      })
      expire = expire || 24*3600
      // 过期时间默认1天
      client.expire(key, expire)
    })
  },
  /**
   * return false || value
   */
  get: (key) => {
    return new Promise((resolve, reject) => {
      if (!redisIsOk) {
        reject(false)
      }
      client.get(key).then((value) => {
        resolve(value)
      })
    })
  },
  del: (key) => {
    if (!redisIsOk) {
      reject(false)
    }
    return new Promise((resolve, reject) => {
      client.del(key).then((value) => {
        resolve(value)
      })
    })
  }
}
```


### 传送门

nodejs 连接sentinel开源库
https://github.com/luin/ioredis

redis持久化存储
https://segmentfault.com/a/1190000002906345

redis看云文档
https://www.kancloud.cn/digest/redis330/162452
