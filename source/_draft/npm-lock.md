---
layout: default
title: 一个npm-lock导致的bug
date: 2018-05-22 19:33:33
tags:
---

## {{page.title}}

### 事情的背景
我司的项目基本上都是后端java，前端随意。
为什么说随意呢，因为前端什么技术都有，react、vue、jquery、regular、seajs...
构建工具用的是gulp+webpack
其实，还算是比较灵活了，虽然没有用nodejs，但是java的ftl模板也足够支持前后端分离了。

由于ftl文件是跟java绑定在一起的，发布一次ftl需要构建+发布java，而这个过程是相当耗时间的。
发布是走的运维提供的一个发布系统，发布需要分两次发布：
1.webpack+gulp构建，然后发前端静态资源到cdn
2.webpack+gulp构建，然后发ftl文件以及java文件到源站。

ps:
理论上来说，ftl文件是可以拆分和java绑定发布的，但是这个未实现。
又，java(ftl)和cdn也是可以构建一次，分别发布的，但是这个同样未实现。

前人做的时候是分了前后端发布，如果改动了静态资源文件需要发布两次，一次是发布静态资源，另一次是发布ftl文件。
问题就出现在这里，同样的代码、ftl文件和静态资源文件npm install & build执行了两次

### 问题

我在将本地构建改为发布构建的时候突然发现某个js资源404了。后面一查，原来是两次构建的文件hash只不一样。
这可把我害苦了，因为不论我怎么清缓存怎么重新修改构建都是同样的情况。

知道突然某个时候有个同事说了一句，同样的代码每次构建也是有可能不一样的。
？？？为什么？难道问题出在package.json？

还别说，真有这个可能，因为我们的package.json文件都是用的上尖括号（范版本）
```shell
"dependencies": {
  "vue": "^2.4.2",
  "vue-resource": "^1.3.4",
  "vue-router": "^2.7.0",
  "vuex": "^3.0.1"
},
```

尖括号的意思是，匹配所有的次要版本

```html
如果配置的是 ^1.1.1
当最新版本为 1.x.x的时候，下次npm install就会自动安装最新的版本。
但是会忽略 2.0.0及以上版本
```

还有一种匹配模式是波浪号，匹配第二次要的版本

```shell
"dependencies": {
  "vue": "~2.4.2",
  "vue-resource": "~1.3.4",
  "vue-router": "~2.7.0",
  "vuex": "~3.0.1"
},
```

比如

```html
如果~1.1.1，当最新版本为 1.1.x的时候，下次npm install就会自动更新最新的版本
但是会忽略 2.2.0及以上版本
```





### 总结
一定要加npm-lock或者yarn.lock，并且提交到代码库来保证所有人使用的node包版本一致
截至目前位置，还是推荐使用yarn


### 问题
更新：


npm shrinkwrap